<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Video-compare-mini</title>
    <style>
        /* CSS siêu nhỏ gọn */
        :root {
            --bg-color: #121212;
            --panel-bg: rgba(30, 30, 30, 0.85);
            --border-color: #444; /* Made slightly lighter for better contrast */
            --text-color: #e0e0e0;
            --text-color-light: #999;
            --highlight-color: #00aaff;
            --danger-color: #ff4d4d; /* NEW: Color for the duration difference */
        }

        body, html {
            margin: 0; padding: 0; font-family: Arial, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            overflow: hidden; height: 100vh; width: 100vw;
        }

        #app-container { display: flex; height: 100%; width: 100%; }

        .video-slot {
            width: 50%; height: 100%; position: relative;
            display: flex; justify-content: center; align-items: center;
            border: 2px dashed #333; box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .video-slot:first-child { border-right: 1px solid #333; }
        .video-slot:last-child { border-left: 1px solid #333; }
        .video-slot.dragging-over {
            border-color: var(--highlight-color);
            background-color: rgba(0, 170, 255, 0.1);
        }
        .video-slot.has-video { border-color: transparent; }
        .video-slot video { max-width: 100%; max-height: 100%; display: block; }
        .drop-text { position: absolute; font-size: 1.5em; color: #555; pointer-events: none; }
        .hidden { display: none !important; }

        #controls {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 100;
            display: flex; align-items: center; gap: 15px;
            padding: 10px 20px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border: 1px solid #333;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .icon-btn { background: none; border: none; color: var(--text-color); cursor: pointer; padding: 5px; }
        .icon-btn svg { width: 22px; height: 22px; fill: currentColor; display: block; }
        
        #time-display-container {
            color: var(--text-color-light);
            font-size: 14px;
            font-family: monospace;
            min-width: 100px;
            text-align: center;
            cursor: pointer;
        }
        #time-input {
            width: 90px;
            background: rgba(0,0,0,0.5);
            color: var(--text-color);
            border: 1px solid var(--highlight-color);
            border-radius: 4px;
            text-align: center;
            padding: 2px;
            font-family: monospace;
            font-size: 14px;
        }

        #timeline-slider { width: 450px; cursor: pointer; }

        /* NEW: Custom styles for the timeline slider track */
        #timeline-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 450px;
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
            transition: opacity 0.2s;
        }

        #timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #fff;
            cursor: pointer;
            border-radius: 50%;
            margin-top: -4px; /* Center thumb on track */
        }

        #timeline-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #fff;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }


        #speed-controls { display: flex; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .speed-btn {
            background: none; border: none; color: var(--text-color-light);
            padding: 6px 12px; cursor: pointer; font-size: 14px;
        }
        .speed-btn.active { color: #fff; background: var(--highlight-color); border-radius: 8px; }
    </style>
</head>
<body>
    <input type="file" id="file-input" accept="video/*" multiple style="display: none;">

    <div id="app-container">
        <div class="video-slot" id="slot-left">
            <video id="video-left" playsinline></video>
            <p class="drop-text" id="drop-text-left">Kéo & Thả Video Trái (hoặc Ctrl+D)</p>
        </div>
        <div class="video-slot" id="slot-right">
            <video id="video-right" playsinline></video>
            <p class="drop-text" id="drop-text-right">Kéo & Thả Video Phải (hoặc Ctrl+D)</p>
        </div>
    </div>

    <div id="controls">
        <button id="play-pause-btn" class="icon-btn" title="Play/Pause (Spacebar)">
            <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pause-icon" class="hidden" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button id="mute-btn" class="icon-btn" title="Mute/Unmute (M)">
            <svg id="unmute-icon" class="hidden" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            <svg id="mute-icon" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L7 9H3v6h4l5 5v-8.27l-5.73-5.73z"/></svg>
        </button>
        <div id="time-display-container">
            <span id="current-time-display">00:00</span> / <span id="duration-display">00:00</span>
        </div>
        <input type="range" id="timeline-slider" value="0" step="0.01" max="100">
        <div id="speed-controls">
            <button class="speed-btn active" data-speed="1">1x</button>
            <button class="speed-btn" data-speed="2">2x</button>
            <button class="speed-btn" data-speed="3">3x</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('file-input');
            const videoLeft = document.getElementById('video-left');
            const videoRight = document.getElementById('video-right');
            const slotLeft = document.getElementById('slot-left');
            const slotRight = document.getElementById('slot-right');
            const timeline = document.getElementById('timeline-slider');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const muteBtn = document.getElementById('mute-btn');
            const muteIcon = document.getElementById('mute-icon');
            const unmuteIcon = document.getElementById('unmute-icon');
            const speedButtons = document.querySelectorAll('.speed-btn');
            const timeDisplayContainer = document.getElementById('time-display-container');
            const currentTimeDisplay = document.getElementById('current-time-display');
            const durationDisplay = document.getElementById('duration-display');

            const videos = [videoLeft, videoRight];
            const slots = [slotLeft, slotRight];
            let readyStates = [false, false];
            let nextTargetSlot = 0;
            const FRAME_TIME = 1 / 30;

            videoLeft.muted = false;
            videoRight.muted = false;
            updateMuteButton();

            function setupDragDrop(slot, index) {
                slot.addEventListener('dragover', e => { e.preventDefault(); slot.classList.add('dragging-over'); });
                slot.addEventListener('dragleave', e => { e.preventDefault(); slot.classList.remove('dragging-over'); });
                slot.addEventListener('drop', e => {
                    e.preventDefault(); slot.classList.remove('dragging-over');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('video/')) loadVideo(index, file);
                });
            }
            slots.forEach(setupDragDrop);
            
            function handleFileSelect(e) {
                const files = e.target.files;
                if (!files.length) return;
                if (!videoLeft.hasAttribute('src') && !videoRight.hasAttribute('src')) {
                    if (files[0] && files[0].type.startsWith('video/')) loadVideo(0, files[0]);
                    if (files[1] && files[1].type.startsWith('video/')) {
                        loadVideo(1, files[1]);
                        nextTargetSlot = 0;
                    } else { nextTargetSlot = 1; }
                } else {
                    if (files[0] && files[0].type.startsWith('video/')) {
                        if (!videoLeft.hasAttribute('src')) {
                           loadVideo(0, files[0]);
                           nextTargetSlot = 1;
                        } else if (!videoRight.hasAttribute('src')) {
                           loadVideo(1, files[0]);
                           nextTargetSlot = 0;
                        } else {
                           loadVideo(nextTargetSlot, files[0]);
                           nextTargetSlot = (nextTargetSlot + 1) % 2;
                        }
                    }
                }
                fileInput.value = '';
            }
            fileInput.addEventListener('change', handleFileSelect);

            function loadVideo(index, file) {
                const video = videos[index];
                if (video.src) URL.revokeObjectURL(video.src);
                video.src = URL.createObjectURL(file);
                video.setAttribute('src', video.src);
                
                document.getElementById(`drop-text-${index === 0 ? 'left' : 'right'}`).classList.add('hidden');
                slots[index].classList.add('has-video');

                video.addEventListener('loadedmetadata', () => {
                    readyStates[index] = true;
                    if (videoLeft.src && videoRight.src && readyStates[0] && readyStates[1]) {
                        syncTimelineDuration();
                    } else if (videoLeft.src || videoRight.src) {
                        syncTimelineDuration();
                    }
                }, { once: true });
            }

            function syncTimelineDuration() {
                const duration1 = videoLeft.duration || 0;
                const duration2 = videoRight.duration || 0;
                const maxDuration = Math.max(duration1, duration2);
                if (isFinite(maxDuration) && maxDuration > 0) {
                    timeline.max = maxDuration;
                    durationDisplay.textContent = formatTime(maxDuration);
                }
                updateTimelineVisuals(); // NEW: Update visuals whenever durations change
            }

            // NEW: Function to update the timeline's background gradient
            function updateTimelineVisuals() {
                const currentTime = parseFloat(timeline.value);
                const duration1 = videoLeft.src ? videoLeft.duration : 0;
                const duration2 = videoRight.src ? videoRight.duration : 0;
                const maxDuration = parseFloat(timeline.max) || 1; // Avoid division by zero
                const minDuration = Math.min(duration1 || Infinity, duration2 || Infinity);

                const playedPercent = (currentTime / maxDuration) * 100;
                
                const styles = getComputedStyle(document.documentElement);
                const highlightColor = styles.getPropertyValue('--highlight-color');
                const borderColor = styles.getPropertyValue('--border-color');
                const dangerColor = styles.getPropertyValue('--danger-color');

                let backgroundGradient;

                // Only show red if two videos are loaded and have different durations
                if (duration1 > 0 && duration2 > 0 && minDuration < maxDuration) {
                    const commonPercent = (minDuration / maxDuration) * 100;
                    backgroundGradient = `linear-gradient(to right, 
                        ${highlightColor} ${playedPercent}%, 
                        ${borderColor} ${playedPercent}%, 
                        ${borderColor} ${commonPercent}%, 
                        ${dangerColor} ${commonPercent}%)`;
                } else {
                    // Default case: one video or two videos of same length
                    backgroundGradient = `linear-gradient(to right, 
                        ${highlightColor} ${playedPercent}%, 
                        ${borderColor} ${playedPercent}%)`;
                }
                
                timeline.style.background = backgroundGradient;
            }

            function togglePlayPause() {
                if (!videoLeft.src && !videoRight.src) return;
                const isPaused = videoLeft.paused || videoRight.paused;
                const action = isPaused ? 'play' : 'pause';
                videos.forEach(v => { if (v.src) v[action](); });
            }

            function updatePlayButton(isPlaying) {
                 playIcon.classList.toggle('hidden', isPlaying);
                 pauseIcon.classList.toggle('hidden', !isPlaying);
            }
            
            function toggleMute() {
                const newMutedState = !videoLeft.muted;
                videos.forEach(v => v.muted = newMutedState);
                updateMuteButton();
            }

            function updateMuteButton() {
                muteIcon.classList.toggle('hidden', !videoLeft.muted);
                unmuteIcon.classList.toggle('hidden', videoLeft.muted);
            }
            
            function setPlaybackSpeed(speed) {
                videos.forEach(v => v.playbackRate = speed);
                speedButtons.forEach(btn => {
                    btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
                });
            }
            
            function formatTime(timeInSeconds) {
                const totalSeconds = Math.floor(timeInSeconds);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function seek(time) {
                const validTime = Math.max(0, Math.min(time, timeline.max));
                timeline.value = validTime;
                videos.forEach(v => { if(v.src) v.currentTime = validTime; });
                updateTimelineVisuals(); // NEW: Update visuals on seek
            }

            playPauseBtn.addEventListener('click', togglePlayPause);
            muteBtn.addEventListener('click', toggleMute);

            timeline.addEventListener('input', () => {
                const time = timeline.value;
                videos.forEach(v => v.currentTime = time);
                updateTimelineVisuals(); // NEW: Update visuals while dragging
            });
            
            videoLeft.addEventListener('timeupdate', () => {
                if (!timeline.matches(':active')) {
                    timeline.value = videoLeft.currentTime;
                    currentTimeDisplay.textContent = formatTime(videoLeft.currentTime);
                    updateTimelineVisuals(); // NEW: Update visuals on timeupdate
                }
            });

            videoLeft.addEventListener('play', () => updatePlayButton(true));
            videoLeft.addEventListener('pause', () => updatePlayButton(false));

            speedButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const speed = parseFloat(button.dataset.speed);
                    setPlaybackSpeed(speed);
                });
            });

            timeDisplayContainer.addEventListener('click', () => {
                const timeInput = document.createElement('input');
                timeInput.type = 'text';
                timeInput.id = 'time-input';
                timeInput.value = currentTimeDisplay.textContent.replace(':', '');

                const restoreTimeDisplay = () => {
                    timeDisplayContainer.innerHTML = '';
                    timeDisplayContainer.appendChild(currentTimeDisplay);
                    timeDisplayContainer.append(` / `);
                    timeDisplayContainer.appendChild(durationDisplay);
                };
                
                const handleTimeSubmit = () => {
                    const rawValue = timeInput.value;
                    let totalSeconds = 0;
                    
                    if (rawValue.includes(':')) {
                        const parts = rawValue.split(':').map(Number);
                        totalSeconds = (parts[0] || 0) * 60 + (parts[1] || 0);
                    } else {
                        const num = parseInt(rawValue, 10);
                        if (!isNaN(num)) {
                            const minutes = Math.floor(num / 100);
                            const seconds = num % 100;
                            totalSeconds = minutes * 60 + seconds;
                        }
                    }
                    
                    seek(totalSeconds);
                    restoreTimeDisplay();
                };

                timeInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); handleTimeSubmit(); } 
                    else if (e.key === 'Escape') { restoreTimeDisplay(); }
                });

                timeInput.addEventListener('blur', handleTimeSubmit);
                
                timeDisplayContainer.innerHTML = '';
                timeDisplayContainer.appendChild(timeInput);
                timeInput.focus();
                timeInput.select();
            });

            window.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;
                if (e.ctrlKey && e.key.toLowerCase() === 'd') {
                    e.preventDefault();
                    fileInput.click();
                }
                
                if (!videoLeft.src && !videoRight.src) return;

                switch(e.key.toLowerCase()) {
                    case ' ': e.preventDefault(); togglePlayPause(); break;
                    case 'm': e.preventDefault(); toggleMute(); break;
                    case 'arrowright':
                        e.preventDefault();
                        if (e.shiftKey) { seek(videoLeft.currentTime + 1); } 
                        else { videos.forEach(v => v.pause()); seek(videoLeft.currentTime + FRAME_TIME); }
                        break;
                    case 'arrowleft':
                        e.preventDefault();
                        if (e.shiftKey) { seek(videoLeft.currentTime - 1); } 
                        else { videos.forEach(v => v.pause()); seek(videoLeft.currentTime - FRAME_TIME); }
                        break;
                }
            });
        });
    </script>
</body>
</html>
